'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { useLoginMutation } from '@/lib/store/services/authApi'
import { useAppDispatch } from '@/lib/hooks'
import { setUser } from '@/lib/store/slices/authSlice'
import { FiMail, FiLock, FiAlertCircle, FiEye, FiEyeOff } from 'react-icons/fi'

export default function LoginPage() {
  const router = useRouter()
  const dispatch = useAppDispatch()
  const [login, { isLoading, error }] = useLoginMutation()

  const [formData, setFormData] = useState({
    email: '',
    password: '',
  })
  const [showPassword, setShowPassword] = useState(false)
  const [validationErrors, setValidationErrors] = useState<{
    email?: string
    password?: string
  }>({})

  // Check if already logged in
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const token = localStorage.getItem('accessToken')
      if (token) {
        router.push('/')
      }
    }
  }, [router])

  const validateForm = () => {
    const errors: { email?: string; password?: string } = {}

    if (!formData.email) {
      errors.email = 'ایمیل الزامی است'
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      errors.email = 'فرمت ایمیل صحیح نیست'
    }

    if (!formData.password) {
      errors.password = 'رمز عبور الزامی است'
    } else if (formData.password.length < 6) {
      errors.password = 'رمز عبور باید حداقل 6 کاراکتر باشد'
    }

    setValidationErrors(errors)
    return Object.keys(errors).length === 0
  }

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target
    setFormData((prev) => ({ ...prev, [name]: value }))
    // Clear validation error for this field
    setValidationErrors((prev) => ({ ...prev, [name]: undefined }))
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()

    if (!validateForm()) {
      return
    }

    try {
      const result = await login(formData).unwrap()
      dispatch(setUser(result.user))
      router.push('/')
    } catch (err: any) {
      console.error('Login failed:', err)
      // Error handling is done via RTK Query error state
    }
  }

  // Parse error message from API
  const getErrorMessage = () => {
    if (!error) return null

    if ('status' in error) {
      if (error.status === 401) {
        return 'ایمیل یا رمز عبور اشتباه است'
      }
      if (error.status === 423) {
        return 'حساب شما به دلیل تلاش‌های ناموفق متعدد قفل شده است. لطفاً بعداً دوباره تلاش کنید.'
      }
      if (error.status === 403) {
        return 'دسترسی غیرمجاز. لطفاً با مدیر سیستم تماس بگیرید.'
      }
      if ('data' in error && typeof error.data === 'object' && error.data !== null) {
        const data = error.data as any
        if (data.message) {
          return data.message
        }
      }
      return 'خطا در ورود به سیستم. لطفاً دوباره تلاش کنید.'
    }

    return 'خطای غیرمنتظره. لطفاً اتصال اینترنت خود را بررسی کنید.'
  }

  const errorMessage = getErrorMessage()

  return (
    <div className="min-h-screen bg-background-base flex items-center justify-center px-4 py-12">
      <div className="max-w-md w-full space-y-8">
        {/* Logo/Title Section */}
        <div className="text-center" dir="rtl">
          <h1 className="text-apple-large-title text-text-primary mb-2">
            ورود به سیستم
          </h1>
          <p className="text-apple-body text-text-secondary">
            برای دسترسی به حساب کاربری خود وارد شوید
          </p>
        </div>

        {/* Login Form Card */}
        <div className="bg-bg-elevated rounded-2xl shadow-apple-card border border-border-light p-8">
          <form onSubmit={handleSubmit} className="space-y-6" dir="rtl">
            {/* Global Error Message */}
            {errorMessage && (
              <div
                className="animate-slide-down-fade flex items-start gap-3 p-4 bg-error-bg border border-error-text/20 rounded-lg"
                role="alert"
              >
                <FiAlertCircle className="text-error-text flex-shrink-0 mt-0.5" />
                <p className="text-sm text-error-text">{errorMessage}</p>
              </div>
            )}

            {/* Email Field */}
            <div>
              <label
                htmlFor="email"
                className="block text-sm font-medium text-text-primary mb-2"
              >
                ایمیل
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                  <FiMail className="text-text-tertiary" />
                </div>
                <input
                  id="email"
                  name="email"
                  type="email"
                  autoComplete="email"
                  required
                  value={formData.email}
                  onChange={handleChange}
                  className={`block w-full pr-10 pl-3 py-3.5 border ${
                    validationErrors.email
                      ? 'border-error-text focus:ring-error-text'
                      : 'border-border-light focus:ring-accent'
                  } rounded-lg bg-bg-base text-text-primary placeholder-text-tertiary focus:outline-none focus:ring-2 focus:border-transparent transition-colors`}
                  placeholder="example@email.com"
                  disabled={isLoading}
                />
              </div>
              {validationErrors.email && (
                <p className="mt-2 text-sm text-error-text">
                  {validationErrors.email}
                </p>
              )}
            </div>

            {/* Password Field */}
            <div>
              <label
                htmlFor="password"
                className="block text-sm font-medium text-text-primary mb-2"
              >
                رمز عبور
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                  <FiLock className="text-text-tertiary" />
                </div>
                <input
                  id="password"
                  name="password"
                  type={showPassword ? 'text' : 'password'}
                  autoComplete="current-password"
                  required
                  value={formData.password}
                  onChange={handleChange}
                  className={`block w-full pr-10 pl-10 py-3.5 border ${
                    validationErrors.password
                      ? 'border-error-text focus:ring-error-text'
                      : 'border-border-light focus:ring-accent'
                  } rounded-lg bg-bg-base text-text-primary placeholder-text-tertiary focus:outline-none focus:ring-2 focus:border-transparent transition-colors`}
                  placeholder="••••••••"
                  disabled={isLoading}
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute inset-y-0 left-0 pl-3 flex items-center text-text-tertiary hover:text-text-primary transition-colors"
                  aria-label={showPassword ? 'مخفی کردن رمز عبور' : 'نمایش رمز عبور'}
                >
                  {showPassword ? <FiEyeOff /> : <FiEye />}
                </button>
              </div>
              {validationErrors.password && (
                <p className="mt-2 text-sm text-error-text">
                  {validationErrors.password}
                </p>
              )}
            </div>

            {/* Submit Button */}
            <button
              type="submit"
              disabled={isLoading}
              className="relative w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-accent hover:bg-accent-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent disabled:opacity-60 disabled:cursor-not-allowed transition-all duration-200 ease-out active-scale-apple"
            >
              {/* Loading spinner overlay */}
              {isLoading && (
                <div className="absolute inset-0 flex items-center justify-center">
                  <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                </div>
              )}

              {/* Button text - hide when loading to prevent layout shift */}
              <span className={`transition-opacity duration-200 ${isLoading ? 'opacity-0' : ''}`}>
                ورود
              </span>
            </button>
          </form>
        </div>

        {/* Back to Home Link */}
        <div className="text-center">
          <button
            onClick={() => router.push('/')}
            className="text-accent hover:text-accent-hover text-sm font-medium transition-colors"
          >
            بازگشت به صفحه اصلی
          </button>
        </div>
      </div>
    </div>
  )
}
